rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    
    // Profile Pictures Rules
    // Path structure: ProfilePictures/{userId}/profile.{extension}
    match /ProfilePictures/{userId}/{allPaths=**} {
      // Anyone can read profile pictures (needed for displaying in chats)
      allow read: if true;
      
      // FIXED: Proper validation on request.resource (not resource)
      // Only authenticated users can upload to their own folder
      allow write: if request.auth != null 
                   && request.auth.uid == userId
                   && request.resource.size < 5 * 1024 * 1024  // 5MB max
                   && request.resource.contentType.matches('image/.*')
                   && request.resource.contentType in ['image/jpeg', 'image/png', 'image/webp', 'image/jpg'];
      
      // Only owner can delete their own pictures
      allow delete: if request.auth != null 
                    && request.auth.uid == userId;
    }
    
    // Profile Pictures Rules (new path structure)
    // Path structure: profile_pictures/{userId}/profile.{extension}
    match /profile_pictures/{userId}/{allPaths=**} {
      // Anyone can read profile pictures (needed for displaying in chats)
      allow read: if true;
      
      // Only authenticated users can upload to their own folder
      allow write: if request.auth != null 
                   && request.auth.uid == userId
                   && request.resource.size < 5 * 1024 * 1024  // 5MB max
                   && request.resource.contentType.matches('image/.*')
                   && request.resource.contentType in ['image/jpeg', 'image/png', 'image/webp', 'image/jpg', 'image/gif'];
      
      // Only owner can delete their own pictures
      allow delete: if request.auth != null 
                    && request.auth.uid == userId;
    }
    
    // Maypole Images Rules
    // Path structure: maypole_images/{maypoleId}/{filename}
    match /maypole_images/{maypoleId}/{allPaths=**} {
      // Anyone authenticated can read maypole images
      allow read: if request.auth != null;
      
      // Authenticated users can create/upload maypole images
      // Note: Rate limiting (10 images/hour per user per maypole) is enforced at application level
      allow create: if request.auth != null
                    && request.resource.size < 10 * 1024 * 1024  // 10MB max
                    && request.resource.contentType.matches('image/.*');
      
      // Allow updating metadata (for Cloud Functions or other operations)
      allow update: if request.auth != null;
      
      // Users can delete images (ownership is verified at application level via Firestore)
      allow delete: if request.auth != null;
    }
    
    // DM Images Rules
    // Path structure: dm_images/{threadId}/{filename}
    match /dm_images/{threadId}/{allPaths=**} {
      // Only authenticated users who are participants in the thread can read DM images
      // Note: Thread participant verification happens at application level
      allow read: if request.auth != null;
      
      // Authenticated users can create/upload DM images (max 5 per message)
      // Participant verification is enforced at application level
      allow create: if request.auth != null
                    && request.resource.size < 10 * 1024 * 1024  // 10MB max
                    && request.resource.contentType.matches('image/.*')
                    && request.resource.contentType in ['image/jpeg', 'image/png', 'image/webp', 'image/jpg', 'image/gif'];
      
      // Users can delete images (ownership is verified at application level)
      allow delete: if request.auth != null;
    }
  }
}
