name: Production Deployment

on:
  push:
    branches:
      - master
      - main

jobs:
  deploy_firebase:
    name: Deploy Firebase Tools (Production)
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Validate Version Format
        run: |
          chmod +x scripts/validate-version.sh scripts/get-version.sh
          echo "ðŸ” Validating version..."
          ./scripts/validate-version.sh
          echo ""
          echo "ðŸ“± Current version:"
          ./scripts/get-version.sh

      - name: Deploy Firebase Tools
        run: |
          echo '${{ secrets.MAYPOLE_FIREBASE_SERVICE_ACCOUNT }}' > $HOME/gcloud-service-key.json
          export GOOGLE_APPLICATION_CREDENTIALS=$HOME/gcloud-service-key.json
          npm install -g firebase-tools
          
          # Deploy all Firebase tools to production
          firebase deploy \
            --only firestore:rules,firestore:indexes,storage,functions \
            --project maypole-flutter-ce6c3 \
            --non-interactive

  build_web:
    name: Build and Deploy Web (Production)
    needs: deploy_firebase
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.7'
          channel: 'stable'

      - name: Flutter pub get
        run: flutter pub get

      - name: Create .env file from secrets
        run: |
          cat > .env << EOF
          # Production Environment Configuration (Generated by GitHub Actions)
          ENVIRONMENT=production
          
          # Firebase Production Configuration
          FIREBASE_PROD_WEB_API_KEY=${{ secrets.FIREBASE_PROD_WEB_API_KEY }}
          FIREBASE_PROD_WEB_APP_ID=${{ secrets.FIREBASE_PROD_WEB_APP_ID }}
          FIREBASE_PROD_WEB_MEASUREMENT_ID=${{ secrets.FIREBASE_PROD_WEB_MEASUREMENT_ID }}
          FIREBASE_PROD_ANDROID_API_KEY=${{ secrets.FIREBASE_PROD_ANDROID_API_KEY }}
          FIREBASE_PROD_ANDROID_APP_ID=${{ secrets.FIREBASE_PROD_ANDROID_APP_ID }}
          FIREBASE_PROD_IOS_API_KEY=${{ secrets.FIREBASE_PROD_IOS_API_KEY }}
          FIREBASE_PROD_IOS_APP_ID=${{ secrets.FIREBASE_PROD_IOS_APP_ID }}
          FIREBASE_PROD_MESSAGING_SENDER_ID=${{ secrets.FIREBASE_PROD_MESSAGING_SENDER_ID }}
          FIREBASE_PROD_PROJECT_ID=${{ secrets.FIREBASE_PROD_PROJECT_ID }}
          FIREBASE_PROD_AUTH_DOMAIN=${{ secrets.FIREBASE_PROD_AUTH_DOMAIN }}
          FIREBASE_PROD_STORAGE_BUCKET=${{ secrets.FIREBASE_PROD_STORAGE_BUCKET }}
          IOS_BUNDLE_ID=${{ secrets.IOS_BUNDLE_ID }}
          EOF

      - name: Build Web
        run: |
          flutter build web --release \
            --web-renderer html \
            --dart-define=ENVIRONMENT=production \
            --dart-define=FIREBASE_PROD_WEB_API_KEY=${{ secrets.FIREBASE_PROD_WEB_API_KEY }} \
            --dart-define=FIREBASE_PROD_WEB_APP_ID=${{ secrets.FIREBASE_PROD_WEB_APP_ID }} \
            --dart-define=FIREBASE_PROD_MESSAGING_SENDER_ID=${{ secrets.FIREBASE_PROD_MESSAGING_SENDER_ID }} \
            --dart-define=FIREBASE_PROD_PROJECT_ID=${{ secrets.FIREBASE_PROD_PROJECT_ID }} \
            --dart-define=FIREBASE_PROD_AUTH_DOMAIN=${{ secrets.FIREBASE_PROD_AUTH_DOMAIN }} \
            --dart-define=FIREBASE_PROD_STORAGE_BUCKET=${{ secrets.FIREBASE_PROD_STORAGE_BUCKET }} \
            --dart-define=FIREBASE_PROD_WEB_MEASUREMENT_ID=${{ secrets.FIREBASE_PROD_WEB_MEASUREMENT_ID }}

      - name: Deploy to Firebase Hosting (Production)
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: '${{ secrets.GITHUB_TOKEN }}'
          fireBaseServiceAccount: ${{ secrets.MAYPOLE_FIREBASE_SERVICE_ACCOUNT }}
          projectId: maypole-flutter-ce6c3
          channelId: live

# Note: Production mobile apps (Android & iOS) are NOT built here.
# They are promoted from beta through the Play Console and App Store Connect UIs.
# This ensures the exact tested beta builds go to production without rebuilding.
